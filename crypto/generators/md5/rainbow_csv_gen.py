#!/usr/bin/env python
import sys
import getopt
import mmap
from time import time
import re
'''
__author__="David Busby"
__copyright__="David Busby <d.busby@saiweb.co.uk>"
__license__="GNU v3 + part 5d section 7: Redistribution/Reuse of this code is permitted under the GNU v3 license, as an additional term ALL code must carry the original Author(s) credit in comment form."
'''

try:
	import hashlib
except:
	print 'Your python version does not include hashlib, consider upgrading your python'
	sys.exit(1) #@todo: I can add fall back onto md5 lib here, when I cba

try:
	import multiprocessing
except:
	print 'This script requires the multiprocessing lib to function, included in python 2.6+ or available from pypi for 2.5'
	sys.exit(1)

def usage():
	print sys.argv[0],'-f /path/to/wordlist.txt -o /output/path/to/rainbow_table.txt -t <max threads, default 1>'


def hash(word):
	word = re.subn('\r','',word)[0]
	word = re.subn('\n','',word)[0]
	m = hashlib.md5()
	m.update(word)
	return {m.hexdigest():word}

def main():
	try:
		opts,args = getopt.getopt(sys.argv[1:],'f:o:',[])
	except getopt.GetoptError, e:
		print e
		usage()
		sys.exit(2)
	
	wlist   = None
	ofile   = None
	threads = 2

	for o,a in opts:
		if o == '-f':
			wlist = a
		elif o == '-o':
			ofile = a
	
	if ofile == None:
		print 'Output file not specified, exiting'
		sys.exit(2)
	if wlist == None:
		print 'Wordlist file not specified exiting'
		sys.exit(2)

	p = multiprocessing.Pool(processes=threads)

	i = 0
	words = []
	for word in open(wlist,'r'):
		words.append(word)
		i+=1

	print 'Got %d words from file, processing' % i
	sTime = time()	
	data = p.map(hash,words)
	eTime = time()
	print 'Completed hashing of %d words in %.2f seconds (%.2f/s)' % (i,(eTime-sTime),(i/(eTime-sTime)))
	
	f = open(ofile,'w+')
	for dict in data:
		for hashmap in dict:
			str = '%s,%s\n' % (hashmap,dict[hashmap])
			f.write(str)
	f.close()
	
	print 'Rainbow table csv format is complete %s' %ofile

if __name__ == '__main__':
	main()
